#!/bin/bash
# (c) Marek `saji' Augustynowicz

##
# {PATH_BREADCRUMBS}{DIR_STACK_SIZE} {GIT_TAG}{GIT_STASH_COUNT} {VIM_SUBSHELL} {USER_AND_HOST} {TIME} {LASTCMD_INFO}
# {PROMPT}
#
# It may look like this:
#
#     ~/.bash/PS1/modules (master)M (vim shell) user@hostname 13:37 ↖ 1s 1
#     $
#
# screenshot: [./saji.png]
##

PS1_debug_trap=

# Have to change directory to `modules/`, as modules depend on
# that when loading other modules.
cd "$( dirname "${BASH_ARGV[0]}" )/../modules"
. ./breadcrumbs
. ./dirstack_size
. ./git_branch
. ./git_counters
. ./git_status
. ./lastcmd
. ./vm
. ./subshell_vim
. ./dropbox
# host's colour is generated from host name
HOSTNAME_HASH=$( echo $HOSTNAME | md5sum )
. ./user_and_host '\e[0;31m' "\e[0;$(( 0x${HOSTNAME_HASH:8:1} * 6 / 16 + 31 ))m"
unset HOSTNAME_HASH
# updates screen(1)'s and terminal's titles
. ./titles
cd - >/dev/null

if [ "UTF-8" = "$( locale charmap )" ]
then
    PS1_ICON_DROPBOX_WORKING=⟳
    PS1_ICON_GIT_STASHED=+
    PS1_ICON_GIT_BEHIND=⊝
    PS1_ICON_GIT_AHEAD=⊕
    PS1_ICON_NONZERO_RETURN=‼
else
    PS1_ICON_DROPBOX_WORKING="*"
    PS1_ICON_GIT_STASHED=+
    PS1_ICON_GIT_BEHIND=-
    PS1_ICON_GIT_AHEAD=+
    PS1_ICON_NONZERO_RETURN="!!"
fi


export PS1='$(
    # four colours for four levels of directories
    #                bold cyan, bold blue, blue,      bold balck
    PS1_breadcrumbs "\e[1;36m" "\e[1;34m" "\e[0;34m" "\e[1;30m"

    # indicator whether dropbox is syncing current directory
    PS1_dropbox " \e[1;34m${PS1_ICON_DROPBOX_WORKING}"

    # size of stack created using `pushd`
    #                 bold black
    PS1_dirstack_size "\e[1;30m"

    # current git branch name
    #             blue
    PS1_git_branch " \e[0;34m"

    # git counters:  stashed,    behind,     ahead
    #                bold black, blue,       bold blue
    PS1_git_counters "\e[1;30m${PS1_ICON_GIT_STASHED}" "\e[0;34m${PS1_ICON_GIT_BEHIND}" "\e[1;34m${PS1_ICON_GIT_AHEAD}"

    # git status:  staging,    working copy
    #              bold cyan, cyan
    PS1_git_status "\e[1;36m" "\e[0;36m"

    # indicator whether we are in a vim subshell
    #                 bold black
    PS1_subshell_vim " \e[1;30m(vim shell)"

    # username and hostname, current time (silver)
) '"$PS1_user_and_host"' \e[0;37m\A$(
    # duration of last executed command and
    # status of last executed command, if different than "0"
    #             bold black, bold red
    PS1_lastcmd " \e[1;30m" "\e[0;31m${PS1_ICON_NONZERO_RETURN}"
    # command prompt in user-specific colour (red for root)
)\e[0m\n$(
    # indicator whether we are in a VirtualBox guest
    #                 bold black
    PS1_vm "VM-"
)$ '
# these variables are no longer needed
unset PS1_user_and_host

[ -n "$PS1_debug_trap" ] && trap $PS1_debug_trap DEBUG
