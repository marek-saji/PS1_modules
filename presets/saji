#!/bin/bash
# (c) Marek `saji' Augustynowicz

##
# {PATH_BREADCRUMBS}{DIR_STACK_SIZE} {GIT_TAG}{GIT_STASH_COUNT} {VIM_SUBSHELL} {USER_AND_HOST} {TIME} {LASTCMD_INFO}
# {PROMPT}
#
# It may look like this:
#
#     ~/.bash/PS1/modules (master)M (vim shell) user@hostname 13:37 ↖ 1s 1
#     $
#
# screenshot: [./saji.png]
##

PS1_debug_trap=

# Have to change directory to `modules/`, as modules depend on
# that when loading other modules.
cd "$( dirname "${BASH_ARGV[0]}" )/../modules"
. ./breadcrumbs
. ./dirstack_size
. ./git_label
. ./git_counters
. ./git_status
. ./lastcmd
. ./vm
. ./subshell_vim
. ./rec
. ./user_and_host
# updates screen(1)'s and terminal's titles
. ./titles
cd - >/dev/null

if [ "$( tput colors )" -ge 256 ]
then
    PS1_BG="$( tput setab 234 )"
else
    PS1_BG="\e[40m"
fi
PS1_RESET_STATUS_BG="\e[0m${PS1_BG}"

if [ "UTF-8" = "$( locale charmap )" ]
then
    PS1_UTF_SUPPORT=1
    PS1_ICON_REC="●"
    PS1_ICON_DROPBOX_WORKING=⟳
    PS1_ICON_GIT_STASHED=+
    PS1_ICON_GIT_BEHIND=⊝
    PS1_ICON_GIT_AHEAD=⊕
    PS1_ICON_NONZERO_RETURN=‼
    PS1_ICON_GROWS_FROM=←
else
    PS1_UTF_SUPPORT=
    PS1_ICON_REC="[rec]"
    PS1_ICON_DROPBOX_WORKING="*"
    PS1_ICON_GIT_STASHED=+
    PS1_ICON_GIT_BEHIND=-
    PS1_ICON_GIT_AHEAD=+
    PS1_ICON_NONZERO_RETURN="!!"
    PS1_ICON_GROWS_FROM="<-"
fi


export PS1="${PS1_user_and_host}${PS1_RESET_STATUS_BG}"' \e[37m\A $(
    printf "${PS1_RESET_STATUS_BG}"

    # indicator whether we are being recorder
    #       bold red
    PS1_rec "\e[1;31m${PS1_ICON_REC} "

    # four colours for four levels of directories
    #               bold cyan, bold blue, blue,               bold balck
    PS1_breadcrumbs "\e[1;36m" "\e[1;34m" "\e[0;34m${PS1_BG}" "\e[1;30m"

    printf "${PS1_RESET_STATUS_BG}"

    # size of stack created using `pushd`
    #                 bold black
    PS1_dirstack_size "\e[1;30m"

    # where are we, gitwise?
    #             heavy blue   heavy blue  blue                                                       blue
    PS1_git_label " \e[1;34m(" "\e[1;34m)" "${PS1_RESET_STATUS_BG}\e[34m ${PS1_ICON_GROWS_FROM} " "…" "${PS1_RESET_STATUS_BG}\e[34m @ "
    printf "${PS1_RESET_STATUS_BG}"

    # git counters:  stashed,                          behind,                                              ahead
    #                bold black,                       blue,                                                bold blue
    PS1_git_counters "\e[1;30m${PS1_ICON_GIT_STASHED}" "${PS1_RESET_STATUS_BG}\e[34m${PS1_ICON_GIT_BEHIND}" "${PS1_RESET_STATUS_BG}\e[1;34m${PS1_ICON_GIT_AHEAD}"
    printf "${PS1_RESET_STATUS_BG}"

    # git status:  staging,   working copy
    #              bold cyan, cyan
    PS1_git_status "\e[1;36m" "${PS1_RESET_STATUS_BG}\e[36m"
    printf "${PS1_RESET_STATUS_BG}"

    # indicator whether we are in a vim subshell
    #                bold black
    PS1_subshell_vim " \e[1;30m(vim shell)"

    # duration of last executed command and
    # status of last executed command, if different than "0"
    #           bold black, bold red
    PS1_lastcmd " \e[1;30m" "\e[1;31m${PS1_ICON_NONZERO_RETURN}"
    # command prompt in user-specific colour (red for root)
)\e[0m\n$(
    # indicator whether we are in a VirtualBox guest
    PS1_vm "VM-"
)$ '
# these variables are no longer needed
unset PS1_user_and_host

[ -n "$PS1_debug_trap" ] && trap $PS1_debug_trap DEBUG
